{% extends "template.html" %}
{% load static %}
{% block title %}Listing Details{% endblock %}

{% block styles %}

<script type="text/javascript">
	window.onload = function() {
		$("#favButton").click(function(ev) {
			ev.preventDefault();

			listing_id = $(this).attr("data-list");

			$.get("/list/" + listing_id + "/favorite", function(data) {
				if(data["status"] == "ok") {
					if(data["message"].indexOf("added") != -1)
						$("#favButton").html('<i class="fas fa-star"></i> Remove from favorites');
					else
						$("#favButton").html('<i class="far fa-star"></i> Add to favorites');

					$("#alertMessage").text(data["message"]);
					$("#alertMessage").css("display", "block");
					$("#alertMessage").delay(1000).fadeOut(400);
				} else
					alert("Error");
			});
		});
		
		$("#submitMessage").click(function(ev) {
			ev.preventDefault();

			listing_id = $(this).attr("data-list");
			var post_data = {
				'csrfmiddlewaretoken':"{{ csrf_token }}",
				'message':$("#messageContent").val()
			}
			$.ajax({
				url:"/list/"+listing_id+"/message",
				type:'POST',
				data:post_data,
				success: function(data){
					if(data["status"] == "ok") {
						
						$("#alertMessage").text(data["message"]);
						$("#alertMessage").css("display", "block");
						$("#alertMessage").delay(1000).fadeOut(400);
					} else
					alert("Error");
				}
			});
			
		}); 
	}
</script>

<link rel="stylesheet" type="text/css" href="{% static 'css/details.css' %}" />

{% endblock %}

{% block content %}

{% if listing %}
<div class="details-page-container">
	<div class="buttons-container">
		<a type="button" class="btn btn-warning fav-button" href="{% url 'update_listing' listing.id%}">Update</a>
		<a id="favButton" type="button" class="btn btn-success fav-button" href="{% url 'favorite' listing.id %}" data-list="{{ listing.id }}">
			{% if is_fav == 0 %}
				<i class="far fa-star"></i> Add to favorites
			{% else %}
				<i class="fas fa-star"></i> Remove from favorites
			{% endif %}
		</a>
		<a type="button" class="btn btn-danger fav-button" href="{% url 'delete_listing' listing.id %}">Delete</a>
	</div>

	<div class="my_details">
		<div>
			<h2 class="listing-title">{{listing.title}}</h2>
		</div>

		<div class="seller-information">
			<h3>{{ listing.estate_id.price|floatformat:-2}} &euro;</h3>

			<a href="#" class="btn btn-primary call-button"><i class="fas fa-phone call-icon"></i> {{ listing.user_id.phone_number }}</a>
			<br>
			<br>
			<br>
			<a href="#"><h4>{{listing.user_id.first_name}}</h4></a>

			<small>Utilizator inregistrat in {{ listing.user_id.created|date:"b Y" }}</small>
			<br>

			<a href="#" class="btn btn-info">Vezi toate anunturile</a>
		</div>

		<div class="image-container">
			<img src="{% if listing.estate_id.image %}{{ listing.estate_id.image.url }}{% endif %}" class="listing-image">
		</div>
		
		<p class="listing-description">{{ listing.description }}</p>

		<table class="table table-bordered table-responsive listing-features">
			<tbody>
				<tr scope="row">
					<td class="td-white-right-borders cl-grey">Oras: </td>
					<td>{{ listing.estate_id.city }}</td>
					<td class="td-white-right-borders cl-grey">Adresa: </td>
					<td>{{ listing.estate_id.address }}</td>
					<td class="td-white-right-borders cl-grey">Nr camere: </td>
					<td>{{ listing.estate_id.rooms }}</td>
					<td class="td-white-right-borders cl-grey">Nr bai: </td>
					<td>{{ listing.estate_id.bathrooms }}</td>
				</tr>
				<tr scope="row">
					<td class="td-white-right-borders cl-grey">Suprafata: </td>
					<td>{{ listing.estate_id.size|floatformat:-2 }} m&sup2;</td>
					<td class="td-white-right-borders cl-grey">Etaj: </td>
					<td>{{ listing.estate_id.floor }}</td>
					<td class="td-white-right-borders cl-grey">An de finalizare: </td>
					<td>{{ listing.estate_id.year }}</td>
					<td class="td-white-right-borders cl-grey">Distanta fata de centru: </td>
					<td>{{ listing.estate_id.distance_to_centre|floatformat:-2 }} km</td>
				</tr>
			</tbody>
		</table>

		<br>
		<span class="contact-seller">Contact: </span>
		<p>Scrie mesajul tau pentru {{listing.user_id.first_name}} aici.</p>

		<form action="#" method="POST" class="col-sm-7 send-message-form">
			<div class="form-group">
				<textarea class="form-control" id="messageContent" rows="3" placeholder="Mesajul tau"></textarea>
			</div>
			<button class="btn btn-primary" id="submitMessage" type="submit" data-list="{{ listing.id }}" ><i class="fas fa-envelope send-message-icon"></i> Trimite</button>
		</form>

	</div>

</div>

<div id="alertMessage" class="alert alert-success alert-message" role="alert"></div>

{% else %}

<h5> No listing found. Please try another.</h5>

{% endif %}

{% endblock %}